import{extractEventInfo as I}from"../../events/event-info-ab2dff62.js";import{frame as g,cancelFrame as w}from"../../frameloop/index-0bf9a1a0.js";import{secondsToMilliseconds as S,millisecondsToSeconds as D}from"../../utils/time-conversion-2fe207ba.js";import{addPointerEvent as m}from"../../events/add-pointer-event-2e752970.js";import{pipe as L}from"../../utils/pipe-0a7cd078.js";import{distance2D as T}from"../../utils/distance-02bcec5a.js";import{frameData as E}from"../../frameloop/data-40fb45d5.js";import{isPrimaryPointer as U}from"../../events/utils/is-primary-pointer-c40e554e.js";class C{constructor(n,o,{transformPagePoint:e}={}){if(this.startEvent=null,this.lastMoveEvent=null,this.lastMoveEventInfo=null,this.handlers={},this.updatePoint=()=>{if(!(this.lastMoveEvent&&this.lastMoveEventInfo))return;const i=p(this.lastMoveEventInfo,this.history),h=this.startEvent!==null,l=T(i.offset,{x:0,y:0})>=3;if(!h&&!l)return;const{point:f}=i,{timestamp:c}=E;this.history.push({...f,timestamp:c});const{onStart:d,onMove:P}=this.handlers;h||(d&&d(this.lastMoveEvent,i),this.startEvent=this.lastMoveEvent),P&&P(this.lastMoveEvent,i)},this.handlePointerMove=(i,h)=>{this.lastMoveEvent=i,this.lastMoveEventInfo=v(h,this.transformPagePoint),g.update(this.updatePoint,!0)},this.handlePointerUp=(i,h)=>{if(this.end(),!(this.lastMoveEvent&&this.lastMoveEventInfo))return;const{onEnd:l,onSessionEnd:f}=this.handlers,c=p(i.type==="pointercancel"?this.lastMoveEventInfo:v(h,this.transformPagePoint),this.history);this.startEvent&&l&&l(i,c),f&&f(i,c)},!U(n))return;this.handlers=o,this.transformPagePoint=e;const r=I(n),a=v(r,this.transformPagePoint),{point:s}=a,{timestamp:x}=E;this.history=[{...s,timestamp:x}];const{onSessionStart:u}=o;u&&u(n,p(a,this.history)),this.removeListeners=L(m(window,"pointermove",this.handlePointerMove),m(window,"pointerup",this.handlePointerUp),m(window,"pointercancel",this.handlePointerUp))}updateHandlers(n){this.handlers=n}end(){this.removeListeners&&this.removeListeners(),w(this.updatePoint)}}function v(t,n){return n?{point:n(t.point)}:t}function y(t,n){return{x:t.x-n.x,y:t.y-n.y}}function p({point:t},n){return{point:t,delta:y(t,M(n)),offset:y(t,V(n)),velocity:b(n,.1)}}function V(t){return t[0]}function M(t){return t[t.length-1]}function b(t,n){if(t.length<2)return{x:0,y:0};let o=t.length-1,e=null;const r=M(t);for(;o>=0&&(e=t[o],!(r.timestamp-e.timestamp>S(n)));)o--;if(!e)return{x:0,y:0};const a=D(r.timestamp-e.timestamp);if(a===0)return{x:0,y:0};const s={x:(r.x-e.x)/a,y:(r.y-e.y)/a};return s.x===1/0&&(s.x=0),s.y===1/0&&(s.y=0),s}export{C as PanSession};
