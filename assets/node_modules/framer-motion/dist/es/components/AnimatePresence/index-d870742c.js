import{r as t}from"../../../../../react/index-4878784d.js";import{useForceUpdate as z}from"../../utils/use-force-update-c5b5072d.js";import{useIsMounted as F}from"../../utils/use-is-mounted-7315c711.js";import{PresenceChild as C}from"./PresenceChild-cb40df73.js";import{LayoutGroupContext as K}from"../../context/LayoutGroupContext-e3eb1a86.js";import{useIsomorphicLayoutEffect as O}from"../../utils/use-isomorphic-effect-3f07f387.js";import{useUnmountEffect as A}from"../../utils/use-unmount-effect-3ba52ed3.js";const u=o=>o.key||"";function U(o,c){o.forEach(i=>{const a=u(i);c.set(a,i)})}function v(o){const c=[];return t.Children.forEach(o,i=>{t.isValidElement(i)&&c.push(i)}),c}const H=({children:o,custom:c,initial:i=!0,onExitComplete:a,exitBeforeEnter:B,presenceAffectsLayout:E=!0,mode:l="sync"})=>{const R=t.useContext(K).forceRender||z()[0],I=F(),m=v(o);let r=m;const s=t.useRef(new Map).current,f=t.useRef(r),d=t.useRef(new Map).current,x=t.useRef(!0);if(O(()=>{x.current=!1,U(m,d),f.current=r}),A(()=>{x.current=!0,d.clear(),s.clear()}),x.current)return t.createElement(t.Fragment,null,r.map(e=>t.createElement(C,{key:u(e),isPresent:!0,initial:i?void 0:!1,presenceAffectsLayout:E,mode:l},e)));r=[...r];const h=f.current.map(u),g=m.map(u),P=h.length;for(let e=0;e<P;e++){const n=h[e];g.indexOf(n)===-1&&!s.has(n)&&s.set(n,void 0)}return l==="wait"&&s.size&&(r=[]),s.forEach((e,n)=>{if(g.indexOf(n)!==-1)return;const y=d.get(n);if(!y)return;const k=h.indexOf(n);let p=e;if(!p){const L=()=>{d.delete(n),s.delete(n);const M=f.current.findIndex(w=>w.key===n);if(f.current.splice(M,1),!s.size){if(f.current=m,I.current===!1)return;R(),a&&a()}};p=t.createElement(C,{key:u(y),isPresent:!1,onExitComplete:L,custom:c,presenceAffectsLayout:E,mode:l},y),s.set(n,p)}r.splice(k,0,p)}),r=r.map(e=>{const n=e.key;return s.has(n)?e:t.createElement(C,{key:u(e),isPresent:!0,presenceAffectsLayout:E,mode:l},e)}),t.createElement(t.Fragment,null,s.size?r:r.map(e=>t.cloneElement(e)))};export{H as AnimatePresence};
